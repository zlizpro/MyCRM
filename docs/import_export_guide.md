# MiniCRM 数据导入导出功能指南

## 概述

MiniCRM的数据导入导出功能提供了完整的数据管理解决方案，支持多种文件格式和数据类型的导入导出操作。

## 功能特性

### 数据导入
- **支持格式**: CSV、Excel (.xlsx)
- **数据类型**: 客户数据、供应商数据、合同数据
- **字段映射**: 智能字段映射建议和手动配置
- **数据验证**: 使用transfunctions进行严格数据验证
- **批量处理**: 支持大批量数据导入
- **进度显示**: 实时显示导入进度和状态
- **错误处理**: 详细的错误报告和处理建议

### 数据导出
- **支持格式**: CSV、Excel (.xlsx)、PDF
- **字段选择**: 灵活的字段选择和自定义
- **数据筛选**: 支持条件筛选和范围选择
- **批量导出**: 支持大批量数据导出
- **格式化输出**: 自动格式化货币、日期等字段

### 文档生成
- **Word文档**: 基于模板的Word文档生成
- **PDF报表**: 专业的PDF报表生成
- **模板管理**: 支持自定义模板和样式

## 使用指南

### 数据导入流程

1. **选择导入文件**
   - 点击"浏览..."按钮选择CSV或Excel文件
   - 系统会自动验证文件格式和大小
   - 支持的文件大小限制为50MB

2. **数据预览**
   - 点击"预览数据"查看文件内容
   - 系统显示前5行数据供确认
   - 检查数据格式是否正确

3. **字段映射**
   - 系统提供智能映射建议
   - 手动调整字段映射关系
   - 确保必填字段（标记*）已正确映射

4. **导入选项**
   - 跳过重复数据：避免重复导入
   - 更新现有数据：更新已存在的记录
   - 严格数据验证：启用完整的数据验证

5. **开始导入**
   - 点击"开始导入"执行导入操作
   - 实时查看导入进度和状态
   - 导入完成后查看结果报告

### 数据导出流程

1. **选择导出设置**
   - 选择数据类型（客户、供应商、合同）
   - 选择导出格式（CSV、Excel、PDF）
   - 设置输出文件路径

2. **字段选择**
   - 选择要导出的字段
   - 使用"全选"/"取消全选"快速操作
   - 根据需要自定义字段组合

3. **开始导出**
   - 点击"开始导出"执行导出操作
   - 查看导出进度
   - 导出完成后确认文件位置

### 文档生成流程

1. **选择模板类型**
   - 合同模板：生成标准合同文档
   - 报价单模板：生成专业报价单
   - 客户报告模板：生成客户分析报告

2. **配置输出设置**
   - 选择输出文件路径
   - 设置文档格式（Word/PDF）

3. **生成文档**
   - 点击"生成文档"创建文档
   - 系统自动填充数据和格式化

## 文件格式要求

### CSV文件格式
```csv
客户名称,联系人,电话,邮箱,公司名称,地址,备注
ABC公司,张经理,138-1234-5678,zhang@abc.com,ABC有限公司,北京市朝阳区,重要客户
XYZ企业,李总,139-5678-9012,li@xyz.com,XYZ集团,上海市浦东新区,潜在客户
```

### Excel文件格式
- 使用第一行作为标题行
- 数据从第二行开始
- 支持.xlsx格式（Excel 2007及以上）

### 字段映射规则

#### 客户数据字段
- **必填字段**: 客户名称、联系人、电话
- **可选字段**: 邮箱、公司名称、地址、备注
- **自动映射**: 系统会自动识别常见字段名称

#### 供应商数据字段
- **必填字段**: 供应商名称、联系人、电话
- **可选字段**: 邮箱、公司名称、地址、备注

#### 合同数据字段
- **必填字段**: 合同编号、客户名称、合同金额
- **可选字段**: 合同状态、签署日期、到期日期

## 数据验证规则

### 电话号码验证
- 支持格式：138-1234-5678、13812345678
- 必须为有效的中国手机号码

### 邮箱验证
- 必须符合标准邮箱格式
- 例如：user@example.com

### 金额验证
- 必须为有效的数字格式
- 支持小数点后两位

## 错误处理

### 常见错误及解决方案

1. **文件格式错误**
   - 确保文件为CSV或Excel格式
   - 检查文件编码为UTF-8

2. **字段映射错误**
   - 确保必填字段已正确映射
   - 检查字段名称是否匹配

3. **数据验证失败**
   - 检查电话号码格式
   - 验证邮箱地址格式
   - 确保必填字段不为空

4. **导入失败**
   - 检查数据库连接
   - 确认用户权限
   - 查看详细错误日志

## 性能优化

### 大文件处理
- 文件大小限制：50MB
- 分批处理：自动分批处理大量数据
- 内存管理：优化内存使用，避免溢出

### 导入性能
- 批量插入：使用批量操作提高效率
- 异步处理：后台处理，不阻塞UI
- 进度反馈：实时显示处理进度

## 安全考虑

### 数据安全
- 文件验证：严格验证文件类型和内容
- 数据验证：完整的数据格式验证
- 错误处理：不暴露敏感系统信息

### 访问控制
- 用户权限：基于用户角色的访问控制
- 操作日志：记录所有导入导出操作
- 数据备份：自动备份重要数据

## 技术实现

### 架构设计
```
ImportExportPanel (UI层)
├── ImportWorker (导入线程)
├── ExportWorker (导出线程)
└── ImportExportService (业务逻辑层)
    ├── CSV处理
    ├── Excel处理
    ├── PDF生成
    └── Word文档生成
```

### 依赖库
- **pandas**: CSV/Excel文件处理
- **openpyxl**: Excel文件读写
- **reportlab**: PDF生成
- **docxtpl**: Word模板处理
- **transfunctions**: 数据验证和格式化

### 代码示例

#### 使用导入导出服务
```python
from minicrm.services.import_export_service import ImportExportService

# 创建服务实例
service = ImportExportService(customer_service, supplier_service, contract_service)

# 导入数据
success_count, error_count, errors = service.import_data(
    file_path="customers.csv",
    data_type="customers",
    field_mapping={"name": "客户名称", "phone": "电话"},
    options={"skip_duplicates": True}
)

# 导出数据
service.export_data(
    data_type="customers",
    export_format=".csv",
    output_path="export.csv",
    fields=["name", "phone", "email"]
)
```

#### 使用UI组件
```python
from minicrm.ui.import_export_panel import ImportExportPanel

# 创建面板
panel = ImportExportPanel(import_export_service)

# 添加到主窗口
main_window.addTab(panel, "数据管理")
```

## 故障排除

### 常见问题

1. **导入速度慢**
   - 检查文件大小和网络连接
   - 考虑分批导入大文件
   - 关闭不必要的数据验证

2. **内存不足**
   - 减少单次处理的数据量
   - 关闭其他应用程序
   - 增加系统内存

3. **格式不兼容**
   - 确认文件格式正确
   - 检查字符编码
   - 验证数据结构

### 日志查看
- 导入导出操作会记录详细日志
- 日志位置：应用程序日志目录
- 日志级别：INFO、WARNING、ERROR

## 更新历史

### v1.0.0 (2025-01-15)
- 初始版本发布
- 支持CSV/Excel导入导出
- 基础PDF生成功能
- 完整的数据验证

### 计划功能
- Word文档模板系统
- 高级数据筛选
- 自定义导出格式
- 批量文档生成

## 技术支持

如有问题或建议，请联系开发团队或查看项目文档。
