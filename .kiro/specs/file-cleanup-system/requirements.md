# 文件清理系统需求文档

## 介绍

本文档定义了MiniCRM项目文件清理系统的需求。该系统旨在识别、分类和安全清理项目中的无用和过期文件，以优化项目结构、减少存储空间占用，并提高项目的可维护性。

文件清理系统将提供智能的文件分析功能，能够区分不同类型的文件（缓存文件、构建产物、测试文件、源代码等），并根据预定义的规则和用户配置进行安全的清理操作。系统还将包含完整的备份和恢复机制，确保重要文件不会被误删。

## 需求

### 需求1：智能文件扫描和分类

**用户故事：** 作为开发者，我希望系统能够自动扫描项目目录并智能分类不同类型的文件，以便我能够了解项目中存在哪些可能无用的文件。

#### 验收标准

1. WHEN 系统启动文件扫描 THEN 系统应该递归扫描整个项目目录
2. WHEN 系统扫描文件 THEN 系统应该将文件分类为以下类型：
   - 缓存文件（__pycache__、.mypy_cache、.ruff_cache等）
   - 构建产物（build/、dist/、htmlcov/等）
   - 系统临时文件（.DS_Store、Thumbs.db等）
   - 测试数据文件（test_*.xlsx、test_*.pdf等）
   - 重复或旧版本文件（*_old.py、*_backup.py等）
   - 源代码文件
   - 配置文件
   - 文档文件
3. WHEN 文件分类完成 THEN 系统应该生成分类统计报告，包含每种类型的文件数量和占用空间
4. IF 文件扩展名或路径模式不在预定义规则中 THEN 系统应该将其标记为"未知类型"并要求用户确认分类

### 需求2：依赖关系分析

**用户故事：** 作为开发者，我希望系统能够分析文件之间的依赖关系，以避免删除仍在使用中的文件。

#### 验收标准

1. WHEN 系统分析Python源代码文件 THEN 系统应该解析import语句以识别文件依赖关系
2. WHEN 系统分析配置文件 THEN 系统应该检查配置文件是否被其他文件引用
3. WHEN 系统分析文档文件 THEN 系统应该检查文档是否在README或其他文档中被引用
4. IF 文件被其他文件引用 THEN 系统应该将其标记为"有依赖"并在清理时发出警告
5. WHEN 依赖分析完成 THEN 系统应该生成依赖关系图，显示文件之间的引用关系

### 需求3：安全清理机制

**用户故事：** 作为项目维护者，我希望能够安全地清理无用文件，并在清理前得到详细的确认信息，以避免误删重要文件。

#### 验收标准

1. WHEN 用户选择要清理的文件 THEN 系统应该显示详细的清理预览，包括文件路径、大小和类型
2. WHEN 用户确认清理操作 THEN 系统应该提供三级确认机制：
   - 第一级：显示将要删除的文件列表
   - 第二级：对于有依赖关系的文件进行特别确认
   - 第三级：对于源代码文件进行最终确认
3. WHEN 系统执行清理操作 THEN 系统应该在删除文件前自动创建备份
4. WHEN 清理过程中出现错误 THEN 系统应该停止操作并提供详细的错误信息
5. IF 文件正在被其他进程使用 THEN 系统应该跳过该文件并记录警告信息

### 需求4：备份和恢复功能

**用户故事：** 作为开发者，我希望在清理文件后能够恢复误删的重要文件，以确保项目的完整性。

#### 验收标准

1. WHEN 系统删除文件 THEN 系统应该将文件备份到指定的备份目录
2. WHEN 创建备份 THEN 备份应该保持原始的目录结构和文件属性
3. WHEN 用户请求恢复文件 THEN 系统应该提供文件恢复界面，显示可恢复的文件列表
4. WHEN 用户选择恢复文件 THEN 系统应该将文件从备份目录恢复到原始位置
5. IF 原始位置已存在同名文件 THEN 系统应该询问用户是否覆盖或重命名
6. WHEN 备份目录超过指定大小限制 THEN 系统应该自动清理最旧的备份文件

### 需求5：清理报告和统计

**用户故事：** 作为项目管理者，我希望获得详细的清理报告，了解清理操作的效果和项目空间的优化情况。

#### 验收标准

1. WHEN 清理操作完成 THEN 系统应该生成详细的清理报告
2. WHEN 生成清理报告 THEN 报告应该包含以下信息：
   - 删除的文件数量和总大小
   - 按文件类型分组的统计信息
   - 节省的磁盘空间
   - 清理操作的时间戳
   - 备份文件的位置和大小
3. WHEN 系统生成统计信息 THEN 应该提供清理前后的项目大小对比
4. WHEN 用户查看历史报告 THEN 系统应该保存最近10次清理操作的报告
5. IF 清理过程中出现警告或错误 THEN 报告应该包含详细的警告和错误信息

### 需求6：用户界面和交互

**用户故事：** 作为用户，我希望有一个直观易用的界面来执行文件清理操作，并能够实时查看清理进度。

#### 验收标准

1. WHEN 用户启动清理工具 THEN 系统应该显示主界面，包含扫描、清理、恢复和设置功能
2. WHEN 系统执行扫描操作 THEN 应该显示实时进度条和当前扫描的文件路径
3. WHEN 扫描完成 THEN 系统应该以树形结构显示文件分类结果，支持展开/折叠
4. WHEN 用户选择文件进行清理 THEN 系统应该支持多选、全选和按类型选择
5. WHEN 系统执行清理操作 THEN 应该显示清理进度和当前处理的文件
6. IF 用户取消清理操作 THEN 系统应该安全停止并保持已处理文件的状态

### 需求7：配置和自定义

**用户故事：** 作为高级用户，我希望能够自定义清理规则和配置清理行为，以适应不同的项目需求。

#### 验收标准

1. WHEN 用户访问设置界面 THEN 系统应该提供清理规则配置选项
2. WHEN 用户配置清理规则 THEN 应该能够：
   - 添加自定义文件扩展名到清理列表
   - 设置文件大小阈值
   - 配置备份保留时间
   - 设置排除目录列表
3. WHEN 用户保存配置 THEN 系统应该验证配置的有效性并保存到配置文件
4. WHEN 系统加载配置 THEN 应该使用用户自定义规则覆盖默认规则
5. IF 配置文件损坏或不存在 THEN 系统应该使用默认配置并提示用户

### 需求8：集成和自动化

**用户故事：** 作为DevOps工程师，我希望能够将文件清理功能集成到自动化流程中，定期维护项目的整洁性。

#### 验收标准

1. WHEN 系统提供命令行接口 THEN 应该支持批处理模式的清理操作
2. WHEN 使用命令行模式 THEN 系统应该支持以下参数：
   - --scan-only：仅扫描不清理
   - --auto-confirm：自动确认安全的清理操作
   - --config-file：指定配置文件路径
   - --report-file：指定报告输出路径
3. WHEN 系统在自动化模式下运行 THEN 应该将所有输出记录到日志文件
4. WHEN 自动化清理完成 THEN 系统应该返回适当的退出代码表示操作结果
5. IF 自动化模式下遇到需要用户确认的情况 THEN 系统应该跳过相关文件并记录到日志
