# MiniCRM ä»£ç è´¨é‡æ£€æŸ¥å·¥ä½œæµ
# åœ¨æ¯æ¬¡æ¨é€å’ŒPRæ—¶è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥

name: ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "tests/**"
      - "scripts/**"
      - "*.py"
      - "*.toml"
      - "*.ini"
      - ".pre-commit-config.yaml"
  pull_request:
    branches: [main, develop]
    paths:
      - "src/**"
      - "tests/**"
      - "scripts/**"
      - "*.py"
      - "*.toml"
      - "*.ini"
      - ".pre-commit-config.yaml"

jobs:
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: å®‰è£…uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        run: |
          uv venv
          uv pip install -e .
          uv pip install -r requirements-dev.txt || echo "requirements-dev.txt not found, installing dev dependencies via uv"
          uv add --dev ruff mypy pre-commit

      - name: è¿è¡ŒRuffä»£ç æ£€æŸ¥
        run: |
          uv run ruff check --config ruff.toml src/ --output-format=github

      - name: è¿è¡ŒRuffä»£ç æ ¼å¼åŒ–æ£€æŸ¥
        run: |
          uv run ruff format --config ruff.toml src/ --check --diff

      - name: è¿è¡ŒMyPyç±»å‹æ£€æŸ¥
        run: |
          uv run mypy --config-file=mypy.ini src/minicrm/ --show-error-codes

      - name: è¿è¡Œæ–‡ä»¶å¤§å°æ£€æŸ¥
        run: |
          python scripts/check_file_sizes.py

      - name: è¿è¡Œtransfunctionsä½¿ç”¨æ£€æŸ¥
        run: |
          python scripts/check_transfunctions_usage.py

      - name: è¿è¡Œæ¶æ„ä¾èµ–æ£€æŸ¥
        run: |
          python scripts/modularity_check.py --all || echo "æ¶æ„æ£€æŸ¥å®Œæˆ"

      - name: è¿è¡Œä»£ç è¦†ç›–ç‡æ£€æŸ¥
        run: |
          uv add --dev pytest pytest-cov coverage
          python scripts/check_coverage.py --min-coverage 70.0

      - name: ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        if: always()
        run: |
          echo "## ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š" > quality-report.md
          echo "### æ£€æŸ¥æ—¶é—´: $(date)" >> quality-report.md
          echo "### Pythonç‰ˆæœ¬: ${{ matrix.python-version }}" >> quality-report.md
          echo "" >> quality-report.md

          echo "### Ruffæ£€æŸ¥ç»“æœ" >> quality-report.md
          uv run ruff check --config ruff.toml src/ --statistics >> quality-report.md || echo "Ruffæ£€æŸ¥å‘ç°é—®é¢˜" >> quality-report.md
          echo "" >> quality-report.md

          echo "### æ–‡ä»¶å¤§å°æ£€æŸ¥ç»“æœ" >> quality-report.md
          python scripts/check_file_sizes.py >> quality-report.md || echo "æ–‡ä»¶å¤§å°æ£€æŸ¥å‘ç°é—®é¢˜" >> quality-report.md
          echo "" >> quality-report.md

          echo "### Transfunctionsä½¿ç”¨æ£€æŸ¥ç»“æœ" >> quality-report.md
          python scripts/check_transfunctions_usage.py >> quality-report.md || echo "Transfunctionsä½¿ç”¨æ£€æŸ¥å‘ç°é—®é¢˜" >> quality-report.md
          echo "" >> quality-report.md

          echo "### ä»£ç è¦†ç›–ç‡æ£€æŸ¥ç»“æœ" >> quality-report.md
          if [ -f coverage-summary.md ]; then
            cat coverage-summary.md >> quality-report.md
          else
            echo "è¦†ç›–ç‡æ£€æŸ¥æœªè¿è¡Œæˆ–å¤±è´¥" >> quality-report.md
          fi

      - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-report-${{ matrix.python-version }}
          path: |
            quality-report.md
            coverage-summary.md
            htmlcov/
            coverage.xml
            coverage.json

      - name: è¯„è®ºPRï¼ˆå¦‚æœæ˜¯PRï¼‰
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const report = fs.readFileSync('quality-report.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š\n\n${report}`
              });
            } catch (error) {
              console.log('æ— æ³•è¯»å–è´¨é‡æŠ¥å‘Šæ–‡ä»¶:', error);
            }

  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡ŒBanditå®‰å…¨æ‰«æ
        uses: tj-actions/bandit@v5.1
        with:
          options: "-r src/ -f json -o bandit-report.json"

      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json

  dependency-check:
    name: ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: å®‰è£…uv
        uses: astral-sh/setup-uv@v3

      - name: è¿è¡Œä¾èµ–å®‰å…¨æ£€æŸ¥
        run: |
          uv add --dev safety
          uv run safety check --json --output safety-report.json || echo "ä¾èµ–å®‰å…¨æ£€æŸ¥å®Œæˆ"

      - name: ä¸Šä¼ ä¾èµ–å®‰å…¨æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-report
          path: safety-report.json
