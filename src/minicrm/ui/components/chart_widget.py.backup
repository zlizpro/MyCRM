"""
MiniCRM å›¾è¡¨ç»„ä»¶

å®žçŽ°æ•°æ®å¯è§†åŒ–å›¾è¡¨ï¼Œæä¾›ï¼š
- å¤šç§å›¾è¡¨ç±»åž‹ï¼ˆæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ç­‰ï¼‰
- matplotlibé›†æˆ
- äº¤äº’åŠŸèƒ½
- ä¸»é¢˜æ”¯æŒ
- æ•°æ®å¯¼å‡º
"""

import logging
from typing import Any

import matplotlib.pyplot as plt
import numpy as np
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure
from PySide6.QtCore import Signal
from PySide6.QtGui import QAction, QFont
from PySide6.QtWidgets import (
    QFrame,
    QHBoxLayout,
    QLabel,
    QMenu,
    QMessageBox,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


class ChartWidget(QWidget):
    """
    å›¾è¡¨ç»„ä»¶

    åŸºäºŽmatplotlibçš„å›¾è¡¨æ˜¾ç¤ºç»„ä»¶ï¼Œæ”¯æŒï¼š
    - å¤šç§å›¾è¡¨ç±»åž‹
    - æ•°æ®æ›´æ–°å’Œåˆ·æ–°
    - äº¤äº’åŠŸèƒ½ï¼ˆç¼©æ”¾ã€å¹³ç§»ï¼‰
    - ä¸»é¢˜åˆ‡æ¢
    - æ•°æ®å¯¼å‡º

    Signals:
        data_point_clicked: æ•°æ®ç‚¹ç‚¹å‡»ä¿¡å· (index: int, value: float)
        chart_exported: å›¾è¡¨å¯¼å‡ºå®Œæˆä¿¡å· (file_path: str)
    """

    # Qtä¿¡å·å®šä¹‰
    data_point_clicked = Signal(int, float)
    chart_exported = Signal(str)

    def __init__(
        self,
        title: str = "",
        chart_type: str = "line",
        width: int = 400,
        height: int = 300,
        parent: QWidget | None = None,
    ):
        """
        åˆå§‹åŒ–å›¾è¡¨ç»„ä»¶

        Args:
            title: å›¾è¡¨æ ‡é¢˜
            chart_type: å›¾è¡¨ç±»åž‹ (line, bar, pie, stacked_bar, area)
            width: å›¾è¡¨å®½åº¦
            height: å›¾è¡¨é«˜åº¦
            parent: çˆ¶ç»„ä»¶
        """
        super().__init__(parent)

        self._logger = logging.getLogger(__name__)

        # å›¾è¡¨å±žæ€§
        self._title = title
        self._chart_type = chart_type
        self._width = width
        self._height = height

        # æ•°æ®
        self._labels: list[str] = []
        self._data: list[float] | list[list[float]] = []
        self._colors: list[str] = []

        # matplotlibç»„ä»¶
        self._figure: Figure | None = None
        self._canvas: FigureCanvas | None = None
        self._axes: Any = None  # matplotlib.axes.Axes

        # UIç»„ä»¶
        self._title_label: QLabel | None = None
        self._toolbar_frame: QFrame | None = None

        # è®¾ç½®ç»„ä»¶
        self._setup_ui()
        self._setup_matplotlib()
        self._setup_default_colors()

        self._logger.debug(f"å›¾è¡¨ç»„ä»¶åˆå§‹åŒ–å®Œæˆ: {title} ({chart_type})")

    def _setup_ui(self) -> None:
        """è®¾ç½®ç”¨æˆ·ç•Œé¢"""
        try:
            # è®¾ç½®ç»„ä»¶å¤§å°
            self.setFixedSize(self._width, self._height)

            # ä¸»å¸ƒå±€
            main_layout = QVBoxLayout(self)
            main_layout.setContentsMargins(10, 10, 10, 10)
            main_layout.setSpacing(5)

            # åˆ›å»ºæ ‡é¢˜å’Œå·¥å…·æ 
            self._create_header(main_layout)

            # å›¾è¡¨å®¹å™¨å°†åœ¨_setup_matplotlibä¸­åˆ›å»º

        except Exception as e:
            self._logger.error(f"å›¾è¡¨UIè®¾ç½®å¤±è´¥: {e}")
            raise

    def _create_header(self, layout: QVBoxLayout) -> None:
        """åˆ›å»ºæ ‡é¢˜å’Œå·¥å…·æ """
        header_frame = QFrame()
        header_layout = QHBoxLayout(header_frame)
        header_layout.setContentsMargins(0, 0, 0, 0)
        header_layout.setSpacing(10)

        # æ ‡é¢˜æ ‡ç­¾
        self._title_label = QLabel(self._title)
        self._title_label.setObjectName("chartTitle")

        title_font = QFont()
        title_font.setPointSize(12)
        title_font.setBold(True)
        self._title_label.setFont(title_font)

        header_layout.addWidget(self._title_label)
        header_layout.addStretch()

        # å·¥å…·æŒ‰é’®
        self._create_toolbar_buttons(header_layout)

        layout.addWidget(header_frame)

    def _create_toolbar_buttons(self, layout: QHBoxLayout) -> None:
        """åˆ›å»ºå·¥å…·æ æŒ‰é’®"""
        # åˆ·æ–°æŒ‰é’®
        refresh_btn = QPushButton("ðŸ”„")
        refresh_btn.setToolTip("åˆ·æ–°å›¾è¡¨")
        refresh_btn.setFixedSize(24, 24)
        refresh_btn.clicked.connect(self.refresh)
        layout.addWidget(refresh_btn)

        # å¯¼å‡ºæŒ‰é’®
        export_btn = QPushButton("ðŸ“¤")
        export_btn.setToolTip("å¯¼å‡ºå›¾è¡¨")
        export_btn.setFixedSize(24, 24)
        export_btn.clicked.connect(self._show_export_menu)
        layout.addWidget(export_btn)

        # è®¾ç½®æŒ‰é’®
        settings_btn = QPushButton("âš™ï¸")
        settings_btn.setToolTip("å›¾è¡¨è®¾ç½®")
        settings_btn.setFixedSize(24, 24)
        settings_btn.clicked.connect(self._show_settings)
        layout.addWidget(settings_btn)

    def _setup_matplotlib(self) -> None:
        """è®¾ç½®matplotlibå›¾è¡¨"""
        try:
            # åˆ›å»ºå›¾å½¢å’Œç”»å¸ƒ
            self._figure = Figure(
                figsize=(self._width / 100, (self._height - 50) / 100), dpi=100
            )
            self._canvas = FigureCanvas(self._figure)

            # è®¾ç½®å›¾å½¢èƒŒæ™¯
            self._figure.patch.set_facecolor("white")

            # åˆ›å»ºåæ ‡è½´
            self._axes = self._figure.add_subplot(111)

            # è®¾ç½®ä¸­æ–‡å­—ä½“æ”¯æŒ
            plt.rcParams["font.sans-serif"] = [
                "Microsoft YaHei",
                "SimHei",
                "DejaVu Sans",
            ]
            plt.rcParams["axes.unicode_minus"] = False

            # æ·»åŠ ç”»å¸ƒåˆ°å¸ƒå±€
            layout = self.layout()
            layout.addWidget(self._canvas)

            # è¿žæŽ¥äº‹ä»¶
            self._canvas.mpl_connect("button_press_event", self._on_canvas_click)

        except Exception as e:
            self._logger.error(f"matplotlibè®¾ç½®å¤±è´¥: {e}")
            raise

    def _setup_default_colors(self) -> None:
        """è®¾ç½®é»˜è®¤é¢œè‰²æ–¹æ¡ˆ"""
        self._colors = [
            "#007bff",  # è“è‰²
            "#28a745",  # ç»¿è‰²
            "#ffc107",  # é»„è‰²
            "#dc3545",  # çº¢è‰²
            "#6f42c1",  # ç´«è‰²
            "#17a2b8",  # é’è‰²
            "#fd7e14",  # æ©™è‰²
            "#20c997",  # é’ç»¿è‰²
            "#6c757d",  # ç°è‰²
            "#e83e8c",  # ç²‰è‰²
        ]

    def update_data(
        self,
        labels: list[str],
        data: list[float] | list[list[float]],
        colors: list[str] | None = None,
    ) -> None:
        """
        æ›´æ–°å›¾è¡¨æ•°æ®

        Args:
            labels: æ•°æ®æ ‡ç­¾
            data: æ•°æ®å€¼ï¼ˆå•ç³»åˆ—æˆ–å¤šç³»åˆ—ï¼‰
            colors: è‡ªå®šä¹‰é¢œè‰²ï¼ˆå¯é€‰ï¼‰
        """
        try:
            self._labels = labels
            self._data = data

            if colors:
                self._colors = colors

            # é‡æ–°ç»˜åˆ¶å›¾è¡¨
            self._draw_chart()

            self._logger.debug(f"å›¾è¡¨æ•°æ®æ›´æ–°å®Œæˆ: {len(labels)}ä¸ªæ•°æ®ç‚¹")

        except Exception as e:
            self._logger.error(f"å›¾è¡¨æ•°æ®æ›´æ–°å¤±è´¥: {e}")

    def _draw_chart(self) -> None:
        """ç»˜åˆ¶å›¾è¡¨"""
        try:
            # æ¸…é™¤çŽ°æœ‰å†…å®¹
            self._axes.clear()

            if not self._labels or not self._data:
                self._axes.text(
                    0.5,
                    0.5,
                    "æš‚æ— æ•°æ®",
                    horizontalalignment="center",
                    verticalalignment="center",
                    transform=self._axes.transAxes,
                    fontsize=14,
                    color="gray",
                )
                self._canvas.draw()
                return

            # æ ¹æ®å›¾è¡¨ç±»åž‹ç»˜åˆ¶
            if self._chart_type == "line":
                self._draw_line_chart()
            elif self._chart_type == "bar":
                self._draw_bar_chart()
            elif self._chart_type == "pie":
                self._draw_pie_chart()
            elif self._chart_type == "stacked_bar":
                self._draw_stacked_bar_chart()
            elif self._chart_type == "area":
                self._draw_area_chart()
            else:
                self._logger.warning(f"ä¸æ”¯æŒçš„å›¾è¡¨ç±»åž‹: {self._chart_type}")
                return

            # è®¾ç½®æ ‡é¢˜
            if self._title:
                self._axes.set_title(
                    self._title, fontsize=12, fontweight="bold", pad=20
                )

            # è°ƒæ•´å¸ƒå±€
            self._figure.tight_layout()

            # åˆ·æ–°ç”»å¸ƒ
            self._canvas.draw()

        except Exception as e:
            self._logger.error(f"å›¾è¡¨ç»˜åˆ¶å¤±è´¥: {e}")

    def _draw_line_chart(self) -> None:
        """ç»˜åˆ¶æŠ˜çº¿å›¾"""
        if isinstance(self._data[0], list):
            # å¤šç³»åˆ—æ•°æ®
            for i, series in enumerate(self._data):
                color = self._colors[i % len(self._colors)]
                self._axes.plot(
                    self._labels,
                    series,
                    marker="o",
                    linewidth=2,
                    markersize=4,
                    color=color,
                    label=f"ç³»åˆ—{i + 1}",
                )
            self._axes.legend()
        else:
            # å•ç³»åˆ—æ•°æ®
            self._axes.plot(
                self._labels,
                self._data,
                marker="o",
                linewidth=2,
                markersize=4,
                color=self._colors[0],
            )

        self._axes.grid(True, alpha=0.3)
        self._axes.set_xlabel("æ—¶é—´")
        self._axes.set_ylabel("æ•°å€¼")

        # æ—‹è½¬xè½´æ ‡ç­¾
        plt.setp(self._axes.get_xticklabels(), rotation=45, ha="right")

    def _draw_bar_chart(self) -> None:
        """ç»˜åˆ¶æŸ±çŠ¶å›¾"""
        x_pos = np.arange(len(self._labels))

        if isinstance(self._data[0], list):
            # å¤šç³»åˆ—æ•°æ®
            bar_width = 0.8 / len(self._data)
            for i, series in enumerate(self._data):
                color = self._colors[i % len(self._colors)]
                offset = (i - len(self._data) / 2 + 0.5) * bar_width
                self._axes.bar(
                    x_pos + offset, series, bar_width, color=color, label=f"ç³»åˆ—{i + 1}"
                )
            self._axes.legend()
        else:
            # å•ç³»åˆ—æ•°æ®
            bars = self._axes.bar(
                x_pos, self._data, color=self._colors[: len(self._data)]
            )

            # åœ¨æŸ±å­ä¸Šæ˜¾ç¤ºæ•°å€¼
            for bar, value in zip(bars, self._data, strict=False):
                height = bar.get_height()
                self._axes.text(
                    bar.get_x() + bar.get_width() / 2.0,
                    height,
                    f"{value:,.0f}",
                    ha="center",
                    va="bottom",
                    fontsize=9,
                )

        self._axes.set_xlabel("ç±»åˆ«")
        self._axes.set_ylabel("æ•°å€¼")
        self._axes.set_xticks(x_pos)
        self._axes.set_xticklabels(self._labels)

        # æ—‹è½¬xè½´æ ‡ç­¾
        plt.setp(self._axes.get_xticklabels(), rotation=45, ha="right")

    def _draw_pie_chart(self) -> None:
        """ç»˜åˆ¶é¥¼å›¾"""
        # ç¡®ä¿æ•°æ®æ˜¯å•ç³»åˆ—çš„
        if not self._data:
            return

        # å¤„ç†æ•°æ®ç±»åž‹
        if isinstance(self._data[0], int | float):
            data = [float(x) for x in self._data if isinstance(x, int | float)]
        else:
            # å¦‚æžœæ˜¯å¤šç³»åˆ—æ•°æ®ï¼Œå–ç¬¬ä¸€ä¸ªç³»åˆ—
            first_series = self._data[0] if isinstance(self._data[0], list) else []
            data = [float(x) for x in first_series if isinstance(x, int | float)]

        # è®¡ç®—ç™¾åˆ†æ¯”
        total = sum(data)
        percentages = [value / total * 100 for value in data]

        # åˆ›å»ºæ ‡ç­¾ï¼ˆåŒ…å«ç™¾åˆ†æ¯”ï¼‰
        pie_labels = [
            f"{label}\n{value:,.0f}\n({pct:.1f}%)"
            for label, value, pct in zip(self._labels, data, percentages, strict=False)
        ]

        # ç»˜åˆ¶é¥¼å›¾
        wedges, texts, autotexts = self._axes.pie(
            data,
            labels=pie_labels,
            colors=self._colors[: len(self._data)],
            autopct="",  # ä¸æ˜¾ç¤ºè‡ªåŠ¨ç™¾åˆ†æ¯”ï¼Œå› ä¸ºå·²ç»åœ¨æ ‡ç­¾ä¸­
            startangle=90,
            textprops={"fontsize": 9},
        )

        # è®¾ç½®ç›¸ç­‰çš„çºµæ¨ªæ¯”ï¼Œç¡®ä¿é¥¼å›¾æ˜¯åœ†å½¢
        self._axes.axis("equal")

    def _draw_stacked_bar_chart(self) -> None:
        """ç»˜åˆ¶å †å æŸ±çŠ¶å›¾"""
        if not isinstance(self._data[0], list):
            self._logger.warning("å †å æŸ±çŠ¶å›¾éœ€è¦å¤šç³»åˆ—æ•°æ®")
            return

        x_pos = np.arange(len(self._labels))
        bottom = np.zeros(len(self._labels))

        for i, series in enumerate(self._data):
            color = self._colors[i % len(self._colors)]
            self._axes.bar(
                x_pos, series, bottom=bottom, color=color, label=f"ç³»åˆ—{i + 1}"
            )
            bottom += np.array(series)

        self._axes.set_xlabel("ç±»åˆ«")
        self._axes.set_ylabel("æ•°å€¼")
        self._axes.set_xticks(x_pos)
        self._axes.set_xticklabels(self._labels)
        self._axes.legend()

        # æ—‹è½¬xè½´æ ‡ç­¾
        plt.setp(self._axes.get_xticklabels(), rotation=45, ha="right")

    def _draw_area_chart(self) -> None:
        """ç»˜åˆ¶é¢ç§¯å›¾"""
        x_pos = np.arange(len(self._labels))

        if isinstance(self._data[0], list):
            # å¤šç³»åˆ—æ•°æ®
            self._axes.stackplot(
                x_pos,
                *self._data,
                labels=[f"ç³»åˆ—{i + 1}" for i in range(len(self._data))],
                colors=self._colors[: len(self._data)],
                alpha=0.7,
            )
            self._axes.legend()
        else:
            # å•ç³»åˆ—æ•°æ®
            self._axes.fill_between(x_pos, self._data, color=self._colors[0], alpha=0.7)
            self._axes.plot(x_pos, self._data, color=self._colors[0], linewidth=2)

        self._axes.set_xlabel("æ—¶é—´")
        self._axes.set_ylabel("æ•°å€¼")
        self._axes.set_xticks(x_pos)
        self._axes.set_xticklabels(self._labels)
        self._axes.grid(True, alpha=0.3)

        # æ—‹è½¬xè½´æ ‡ç­¾
        plt.setp(self._axes.get_xticklabels(), rotation=45, ha="right")

    def _on_canvas_click(self, event) -> None:
        """å¤„ç†ç”»å¸ƒç‚¹å‡»äº‹ä»¶"""
        try:
            if event.inaxes != self._axes:
                return

            # èŽ·å–ç‚¹å‡»ä½ç½®çš„æ•°æ®
            if self._chart_type in ["line", "bar", "area"]:
                # æ‰¾åˆ°æœ€è¿‘çš„æ•°æ®ç‚¹
                if self._labels and self._data:
                    x_data = np.arange(len(self._labels))
                    if isinstance(self._data[0], list):
                        y_data = self._data[0]  # ä½¿ç”¨ç¬¬ä¸€ä¸ªç³»åˆ—
                    else:
                        # ç¡®ä¿æ˜¯å•ç³»åˆ—æ•°æ®
                        if isinstance(self._data[0], int | float):
                            y_data = [
                                float(x)
                                for x in self._data
                                if isinstance(x, int | float)
                            ]
                        else:
                            y_data = []

                    # è®¡ç®—è·ç¦»
                    distances = np.sqrt(
                        (x_data - event.xdata) ** 2
                        + (np.array(y_data) - event.ydata) ** 2
                    )
                    closest_index = np.argmin(distances)

                    # å‘é€ä¿¡å·
                    self.data_point_clicked.emit(closest_index, y_data[closest_index])

                    self._logger.debug(
                        f"æ•°æ®ç‚¹ç‚¹å‡»: ç´¢å¼•{closest_index}, å€¼{y_data[closest_index]}"
                    )

        except Exception as e:
            self._logger.error(f"ç”»å¸ƒç‚¹å‡»å¤„ç†å¤±è´¥: {e}")

    def _show_export_menu(self) -> None:
        """æ˜¾ç¤ºå¯¼å‡ºèœå•"""
        try:
            menu = QMenu(self)

            # PNGå¯¼å‡º
            png_action = QAction("å¯¼å‡ºä¸ºPNG", self)
            png_action.triggered.connect(lambda: self._export_chart("png"))
            menu.addAction(png_action)

            # PDFå¯¼å‡º
            pdf_action = QAction("å¯¼å‡ºä¸ºPDF", self)
            pdf_action.triggered.connect(lambda: self._export_chart("pdf"))
            menu.addAction(pdf_action)

            # SVGå¯¼å‡º
            svg_action = QAction("å¯¼å‡ºä¸ºSVG", self)
            svg_action.triggered.connect(lambda: self._export_chart("svg"))
            menu.addAction(svg_action)

            # æ˜¾ç¤ºèœå•
            sender = self.sender()
            if hasattr(sender, "pos"):
                menu.exec_(self.mapToGlobal(sender.pos()))
            else:
                menu.exec_()

        except Exception as e:
            self._logger.error(f"å¯¼å‡ºèœå•æ˜¾ç¤ºå¤±è´¥: {e}")

    def _export_chart(self, format_type: str) -> None:
        """
        å¯¼å‡ºå›¾è¡¨

        Args:
            format_type: å¯¼å‡ºæ ¼å¼ (png, pdf, svg)
        """
        try:
            from PySide6.QtWidgets import QFileDialog

            # é€‰æ‹©ä¿å­˜è·¯å¾„
            file_filter = {
                "png": "PNGå›¾ç‰‡ (*.png)",
                "pdf": "PDFæ–‡æ¡£ (*.pdf)",
                "svg": "SVGçŸ¢é‡å›¾ (*.svg)",
            }

            file_path, _ = QFileDialog.getSaveFileName(
                self,
                f"å¯¼å‡ºå›¾è¡¨ä¸º{format_type.upper()}",
                f"{self._title}.{format_type}",
                file_filter[format_type],
            )

            if file_path:
                # ä¿å­˜å›¾è¡¨
                self._figure.savefig(
                    file_path, format=format_type, dpi=300, bbox_inches="tight"
                )

                # å‘é€å¯¼å‡ºå®Œæˆä¿¡å·
                self.chart_exported.emit(file_path)

                self._logger.info(f"å›¾è¡¨å¯¼å‡ºæˆåŠŸ: {file_path}")

                # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                QMessageBox.information(self, "å¯¼å‡ºæˆåŠŸ", f"å›¾è¡¨å·²ä¿å­˜åˆ°:\n{file_path}")

        except Exception as e:
            self._logger.error(f"å›¾è¡¨å¯¼å‡ºå¤±è´¥: {e}")
            QMessageBox.critical(self, "å¯¼å‡ºå¤±è´¥", f"å›¾è¡¨å¯¼å‡ºå¤±è´¥:\n{str(e)}")

    def _show_settings(self) -> None:
        """æ˜¾ç¤ºå›¾è¡¨è®¾ç½®"""
        # TODO: å®žçŽ°å›¾è¡¨è®¾ç½®å¯¹è¯æ¡†
        QMessageBox.information(self, "åŠŸèƒ½å¼€å‘ä¸­", "å›¾è¡¨è®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...")

    def refresh(self) -> None:
        """åˆ·æ–°å›¾è¡¨"""
        try:
            self._draw_chart()
            self._logger.debug("å›¾è¡¨åˆ·æ–°å®Œæˆ")

        except Exception as e:
            self._logger.error(f"å›¾è¡¨åˆ·æ–°å¤±è´¥: {e}")

    def set_title(self, title: str) -> None:
        """
        è®¾ç½®å›¾è¡¨æ ‡é¢˜

        Args:
            title: æ–°æ ‡é¢˜
        """
        self._title = title
        if self._title_label:
            self._title_label.setText(title)
        self._draw_chart()

    def set_chart_type(self, chart_type: str) -> None:
        """
        è®¾ç½®å›¾è¡¨ç±»åž‹

        Args:
            chart_type: å›¾è¡¨ç±»åž‹
        """
        if chart_type in ["line", "bar", "pie", "stacked_bar", "area"]:
            self._chart_type = chart_type
            self._draw_chart()
        else:
            self._logger.warning(f"ä¸æ”¯æŒçš„å›¾è¡¨ç±»åž‹: {chart_type}")

    def set_colors(self, colors: list[str]) -> None:
        """
        è®¾ç½®å›¾è¡¨é¢œè‰²

        Args:
            colors: é¢œè‰²åˆ—è¡¨
        """
        self._colors = colors
        self._draw_chart()

    def clear(self) -> None:
        """æ¸…ç©ºå›¾è¡¨"""
        self._labels = []
        self._data = []
        self._draw_chart()

    def get_data(self) -> dict[str, Any]:
        """èŽ·å–å½“å‰å›¾è¡¨æ•°æ®"""
        return {
            "title": self._title,
            "chart_type": self._chart_type,
            "labels": self._labels.copy(),
            "data": self._data.copy() if isinstance(self._data, list) else self._data,
            "colors": self._colors.copy(),
        }

    def __str__(self) -> str:
        """è¿”å›žå›¾è¡¨çš„å­—ç¬¦ä¸²è¡¨ç¤º"""
        return f"ChartWidget(title='{self._title}', type='{self._chart_type}', data_points={len(self._labels)})"
