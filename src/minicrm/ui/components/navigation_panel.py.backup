"""
MiniCRM å¯¼èˆªé¢æ¿ç»„ä»¶

å®ç°å·¦ä¾§å¯¼èˆªé¢æ¿ï¼Œæä¾›ï¼š
- æ ‘å½¢å¯¼èˆªç»“æ„
- å›¾æ ‡å’Œæ–‡å­—æ˜¾ç¤º
- å±•å¼€/æŠ˜å åŠŸèƒ½
- é€‰ä¸­çŠ¶æ€ç®¡ç†
- ç°ä»£åŒ–æ ·å¼
"""

import logging
from dataclasses import dataclass

from PySide6.QtCore import QSize, Qt, Signal
from PySide6.QtGui import QFont, QIcon
from PySide6.QtWidgets import (
    QFrame,
    QLabel,
    QTreeWidget,
    QTreeWidgetItem,
    QVBoxLayout,
    QWidget,
)


@dataclass
class NavigationItem:
    """å¯¼èˆªé¡¹æ•°æ®ç±»"""

    name: str
    display_name: str
    icon: str | None = None
    parent: str | None = None
    page_name: str | None = None
    children: list["NavigationItem"] | None = None


class NavigationPanel(QWidget):
    """
    å¯¼èˆªé¢æ¿ç»„ä»¶

    æä¾›åº”ç”¨ç¨‹åºçš„ä¸»è¦å¯¼èˆªåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
    - åˆ†å±‚çš„å¯¼èˆªç»“æ„
    - å›¾æ ‡å’Œæ–‡å­—æ˜¾ç¤º
    - å±•å¼€/æŠ˜å çŠ¶æ€ç®¡ç†
    - é€‰ä¸­é¡¹é«˜äº®æ˜¾ç¤º
    - å“åº”å¼å¸ƒå±€

    Signals:
        page_requested: é¡µé¢è¯·æ±‚ä¿¡å· (page_name: str)
        item_selected: å¯¼èˆªé¡¹é€‰ä¸­ä¿¡å· (item_name: str)
    """

    # Qtä¿¡å·å®šä¹‰
    page_requested = Signal(str)
    item_selected = Signal(str)

    def __init__(self, parent: QWidget | None = None):
        """
        åˆå§‹åŒ–å¯¼èˆªé¢æ¿

        Args:
            parent: çˆ¶ç»„ä»¶
        """
        super().__init__(parent)

        self._logger = logging.getLogger(__name__)

        # UIç»„ä»¶
        self._tree_widget: QTreeWidget | None = None
        self._title_label: QLabel | None = None

        # å¯¼èˆªæ•°æ®
        self._navigation_items: dict[str, NavigationItem] = {}
        self._tree_items: dict[str, QTreeWidgetItem] = {}

        # è®¾ç½®ç»„ä»¶
        self._setup_ui()
        self._setup_navigation_items()
        self._setup_connections()

        self._logger.debug("å¯¼èˆªé¢æ¿åˆå§‹åŒ–å®Œæˆ")

    def _setup_ui(self) -> None:
        """è®¾ç½®ç”¨æˆ·ç•Œé¢"""
        try:
            # è®¾ç½®ä¸»å¸ƒå±€
            layout = QVBoxLayout(self)
            layout.setContentsMargins(0, 0, 0, 0)
            layout.setSpacing(0)

            # åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
            self._create_title_area(layout)

            # åˆ›å»ºå¯¼èˆªæ ‘
            self._create_navigation_tree(layout)

            # è®¾ç½®æ ·å¼
            self._apply_styles()

        except Exception as e:
            self._logger.error(f"å¯¼èˆªé¢æ¿UIè®¾ç½®å¤±è´¥: {e}")
            raise

    def _create_title_area(self, layout: QVBoxLayout) -> None:
        """åˆ›å»ºæ ‡é¢˜åŒºåŸŸ"""
        # åˆ›å»ºæ ‡é¢˜å®¹å™¨
        title_frame = QFrame()
        title_frame.setObjectName("navigationTitle")
        title_frame.setFixedHeight(60)

        title_layout = QVBoxLayout(title_frame)
        title_layout.setContentsMargins(15, 10, 15, 10)

        # åˆ›å»ºæ ‡é¢˜æ ‡ç­¾
        self._title_label = QLabel("MiniCRM")
        self._title_label.setObjectName("navigationTitleLabel")

        # è®¾ç½®æ ‡é¢˜å­—ä½“
        title_font = QFont()
        title_font.setPointSize(14)
        title_font.setBold(True)
        self._title_label.setFont(title_font)

        title_layout.addWidget(self._title_label)
        layout.addWidget(title_frame)

    def _create_navigation_tree(self, layout: QVBoxLayout) -> None:
        """åˆ›å»ºå¯¼èˆªæ ‘"""
        # åˆ›å»ºæ ‘å½¢æ§ä»¶
        self._tree_widget = QTreeWidget()
        self._tree_widget.setObjectName("navigationTree")

        # è®¾ç½®æ ‘å½¢æ§ä»¶å±æ€§
        self._tree_widget.setHeaderHidden(True)
        self._tree_widget.setRootIsDecorated(True)
        self._tree_widget.setIndentation(20)
        self._tree_widget.setUniformRowHeights(True)
        self._tree_widget.setAnimated(True)

        # è®¾ç½®é€‰æ‹©æ¨¡å¼
        self._tree_widget.setSelectionMode(QTreeWidget.SingleSelection)
        self._tree_widget.setSelectionBehavior(QTreeWidget.SelectRows)

        # è®¾ç½®é¡¹ç›®é«˜åº¦
        self._tree_widget.setIconSize(QSize(20, 20))

        layout.addWidget(self._tree_widget)

    def _setup_navigation_items(self) -> None:
        """è®¾ç½®å¯¼èˆªé¡¹"""
        try:
            # å®šä¹‰å¯¼èˆªç»“æ„
            navigation_data = [
                NavigationItem(
                    name="dashboard",
                    display_name="ğŸ“Š æ•°æ®ä»ªè¡¨ç›˜",
                    page_name="dashboard",
                ),
                NavigationItem(
                    name="customers",
                    display_name="ğŸ‘¥ å®¢æˆ·ç®¡ç†",
                    children=[
                        NavigationItem(
                            name="customer_list",
                            display_name="å®¢æˆ·åˆ—è¡¨",
                            parent="customers",
                            page_name="customer_list",
                        ),
                        NavigationItem(
                            name="customer_types",
                            display_name="å®¢æˆ·ç±»å‹",
                            parent="customers",
                            page_name="customer_types",
                        ),
                        NavigationItem(
                            name="customer_interactions",
                            display_name="äº’åŠ¨è®°å½•",
                            parent="customers",
                            page_name="customer_interactions",
                        ),
                    ],
                ),
                NavigationItem(
                    name="suppliers",
                    display_name="ğŸ­ ä¾›åº”å•†ç®¡ç†",
                    children=[
                        NavigationItem(
                            name="supplier_list",
                            display_name="ä¾›åº”å•†åˆ—è¡¨",
                            parent="suppliers",
                            page_name="supplier_list",
                        ),
                        NavigationItem(
                            name="supplier_quotes",
                            display_name="ä¾›åº”å•†æŠ¥ä»·",
                            parent="suppliers",
                            page_name="supplier_quotes",
                        ),
                        NavigationItem(
                            name="supplier_quality",
                            display_name="è´¨é‡è·Ÿè¸ª",
                            parent="suppliers",
                            page_name="supplier_quality",
                        ),
                    ],
                ),
                NavigationItem(
                    name="business",
                    display_name="ğŸ’¼ ä¸šåŠ¡ç®¡ç†",
                    children=[
                        NavigationItem(
                            name="quotes",
                            display_name="æŠ¥ä»·ç®¡ç†",
                            parent="business",
                            page_name="quotes",
                        ),
                        NavigationItem(
                            name="contracts",
                            display_name="åˆåŒç®¡ç†",
                            parent="business",
                            page_name="contracts",
                        ),
                        NavigationItem(
                            name="service_tickets",
                            display_name="å”®åå·¥å•",
                            parent="business",
                            page_name="service_tickets",
                        ),
                    ],
                ),
                NavigationItem(
                    name="finance",
                    display_name="ğŸ’° è´¢åŠ¡ç®¡ç†",
                    children=[
                        NavigationItem(
                            name="receivables",
                            display_name="åº”æ”¶è´¦æ¬¾",
                            parent="finance",
                            page_name="receivables",
                        ),
                        NavigationItem(
                            name="payables",
                            display_name="åº”ä»˜è´¦æ¬¾",
                            parent="finance",
                            page_name="payables",
                        ),
                        NavigationItem(
                            name="financial_reports",
                            display_name="è´¢åŠ¡æŠ¥è¡¨",
                            parent="finance",
                            page_name="financial_reports",
                        ),
                    ],
                ),
                NavigationItem(
                    name="reports",
                    display_name="ğŸ“Š æŠ¥è¡¨åˆ†æ",
                    children=[
                        NavigationItem(
                            name="customer_reports",
                            display_name="å®¢æˆ·åˆ†æ",
                            parent="reports",
                            page_name="customer_reports",
                        ),
                        NavigationItem(
                            name="sales_reports",
                            display_name="é”€å”®åˆ†æ",
                            parent="reports",
                            page_name="sales_reports",
                        ),
                        NavigationItem(
                            name="supplier_reports",
                            display_name="ä¾›åº”å•†åˆ†æ",
                            parent="reports",
                            page_name="supplier_reports",
                        ),
                    ],
                ),
                NavigationItem(
                    name="settings",
                    display_name="âš™ï¸ ç³»ç»Ÿè®¾ç½®",
                    children=[
                        NavigationItem(
                            name="general_settings",
                            display_name="å¸¸è§„è®¾ç½®",
                            parent="settings",
                            page_name="general_settings",
                        ),
                        NavigationItem(
                            name="database_settings",
                            display_name="æ•°æ®åº“è®¾ç½®",
                            parent="settings",
                            page_name="database_settings",
                        ),
                        NavigationItem(
                            name="backup_settings",
                            display_name="å¤‡ä»½è®¾ç½®",
                            parent="settings",
                            page_name="backup_settings",
                        ),
                    ],
                ),
            ]

            # æ„å»ºå¯¼èˆªæ ‘
            self._build_navigation_tree(navigation_data)

            # å±•å¼€æ‰€æœ‰é¡¶çº§é¡¹
            self._tree_widget.expandAll()

            # é€‰ä¸­é»˜è®¤é¡¹ï¼ˆä»ªè¡¨ç›˜ï¼‰
            if "dashboard" in self._tree_items:
                self._tree_widget.setCurrentItem(self._tree_items["dashboard"])

        except Exception as e:
            self._logger.error(f"å¯¼èˆªé¡¹è®¾ç½®å¤±è´¥: {e}")
            raise

    def _build_navigation_tree(self, navigation_data: list[NavigationItem]) -> None:
        """æ„å»ºå¯¼èˆªæ ‘"""
        # æ¸…ç©ºç°æœ‰é¡¹
        self._tree_widget.clear()
        self._navigation_items.clear()
        self._tree_items.clear()

        # æ·»åŠ é¡¶çº§é¡¹
        for item_data in navigation_data:
            self._add_navigation_item(item_data)

    def _add_navigation_item(
        self, item_data: NavigationItem, parent_item: QTreeWidgetItem | None = None
    ) -> QTreeWidgetItem:
        """æ·»åŠ å¯¼èˆªé¡¹"""
        # åˆ›å»ºæ ‘é¡¹
        if parent_item:
            tree_item = QTreeWidgetItem(parent_item)
        else:
            tree_item = QTreeWidgetItem(self._tree_widget)

        # è®¾ç½®æ–‡æœ¬
        tree_item.setText(0, item_data.display_name)

        # è®¾ç½®æ•°æ®
        tree_item.setData(0, Qt.UserRole, item_data.name)

        # è®¾ç½®å›¾æ ‡ï¼ˆå¦‚æœæœ‰ï¼‰
        if item_data.icon:
            icon = QIcon(item_data.icon)
            tree_item.setIcon(0, icon)

        # å­˜å‚¨é¡¹ç›®
        self._navigation_items[item_data.name] = item_data
        self._tree_items[item_data.name] = tree_item

        # æ·»åŠ å­é¡¹
        if item_data.children:
            for child_data in item_data.children:
                self._add_navigation_item(child_data, tree_item)

        return tree_item

    def _setup_connections(self) -> None:
        """è®¾ç½®ä¿¡å·è¿æ¥"""
        if self._tree_widget:
            self._tree_widget.itemClicked.connect(self._on_item_clicked)
            self._tree_widget.itemDoubleClicked.connect(self._on_item_double_clicked)

    def _apply_styles(self) -> None:
        """åº”ç”¨æ ·å¼"""
        # è®¾ç½®æ ·å¼è¡¨
        self.setStyleSheet("""
            QWidget#navigationTitle {
                background-color: #f8f9fa;
                border-bottom: 1px solid #dee2e6;
            }

            QLabel#navigationTitleLabel {
                color: #495057;
                font-weight: bold;
            }

            QTreeWidget#navigationTree {
                background-color: #ffffff;
                border: none;
                outline: none;
                font-size: 13px;
            }

            QTreeWidget#navigationTree::item {
                height: 36px;
                padding: 4px 8px;
                border: none;
            }

            QTreeWidget#navigationTree::item:hover {
                background-color: #e9ecef;
            }

            QTreeWidget#navigationTree::item:selected {
                background-color: #007bff;
                color: white;
            }

            QTreeWidget#navigationTree::item:selected:hover {
                background-color: #0056b3;
            }

            QTreeWidget#navigationTree::branch {
                background: transparent;
            }

            QTreeWidget#navigationTree::branch:has-children:!has-siblings:closed,
            QTreeWidget#navigationTree::branch:closed:has-children:has-siblings {
                border-image: none;
                image: url(:/icons/branch-closed.png);
            }

            QTreeWidget#navigationTree::branch:open:has-children:!has-siblings,
            QTreeWidget#navigationTree::branch:open:has-children:has-siblings {
                border-image: none;
                image: url(:/icons/branch-open.png);
            }
        """)

    def _on_item_clicked(self, item: QTreeWidgetItem, column: int) -> None:
        """å¤„ç†é¡¹ç›®ç‚¹å‡»äº‹ä»¶"""
        try:
            item_name = item.data(0, Qt.UserRole)
            if item_name in self._navigation_items:
                nav_item = self._navigation_items[item_name]

                # å‘é€é€‰ä¸­ä¿¡å·
                self.item_selected.emit(item_name)

                # å¦‚æœæœ‰é¡µé¢åç§°ï¼Œå‘é€é¡µé¢è¯·æ±‚ä¿¡å·
                if nav_item.page_name:
                    self.page_requested.emit(nav_item.page_name)
                    self._logger.debug(f"è¯·æ±‚é¡µé¢: {nav_item.page_name}")

        except Exception as e:
            self._logger.error(f"å¯¼èˆªé¡¹ç‚¹å‡»å¤„ç†å¤±è´¥: {e}")

    def _on_item_double_clicked(self, item: QTreeWidgetItem, column: int) -> None:
        """å¤„ç†é¡¹ç›®åŒå‡»äº‹ä»¶"""
        try:
            # åŒå‡»æ—¶å±•å¼€/æŠ˜å é¡¹ç›®
            if item.childCount() > 0:
                item.setExpanded(not item.isExpanded())

        except Exception as e:
            self._logger.error(f"å¯¼èˆªé¡¹åŒå‡»å¤„ç†å¤±è´¥: {e}")

    def select_item(self, item_name: str) -> bool:
        """
        é€‰ä¸­æŒ‡å®šçš„å¯¼èˆªé¡¹

        Args:
            item_name: å¯¼èˆªé¡¹åç§°

        Returns:
            bool: æ˜¯å¦æˆåŠŸé€‰ä¸­
        """
        try:
            if item_name in self._tree_items:
                tree_item = self._tree_items[item_name]
                self._tree_widget.setCurrentItem(tree_item)

                # ç¡®ä¿çˆ¶é¡¹å±•å¼€
                parent = tree_item.parent()
                while parent:
                    parent.setExpanded(True)
                    parent = parent.parent()

                return True

            return False

        except Exception as e:
            self._logger.error(f"é€‰ä¸­å¯¼èˆªé¡¹å¤±è´¥: {e}")
            return False

    def get_selected_item(self) -> str | None:
        """
        è·å–å½“å‰é€‰ä¸­çš„å¯¼èˆªé¡¹

        Returns:
            Optional[str]: é€‰ä¸­çš„å¯¼èˆªé¡¹åç§°ï¼Œå¦‚æœæ²¡æœ‰é€‰ä¸­åˆ™è¿”å›None
        """
        try:
            current_item = self._tree_widget.currentItem()
            if current_item:
                return current_item.data(0, Qt.UserRole)
            return None

        except Exception as e:
            self._logger.error(f"è·å–é€‰ä¸­é¡¹å¤±è´¥: {e}")
            return None

    def expand_all(self) -> None:
        """å±•å¼€æ‰€æœ‰é¡¹ç›®"""
        if self._tree_widget:
            self._tree_widget.expandAll()

    def collapse_all(self) -> None:
        """æŠ˜å æ‰€æœ‰é¡¹ç›®"""
        if self._tree_widget:
            self._tree_widget.collapseAll()

    def refresh(self) -> None:
        """åˆ·æ–°å¯¼èˆªé¢æ¿"""
        try:
            # ä¿å­˜å½“å‰é€‰ä¸­é¡¹
            selected_item = self.get_selected_item()

            # é‡æ–°è®¾ç½®å¯¼èˆªé¡¹
            self._setup_navigation_items()

            # æ¢å¤é€‰ä¸­é¡¹
            if selected_item:
                self.select_item(selected_item)

            self._logger.debug("å¯¼èˆªé¢æ¿åˆ·æ–°å®Œæˆ")

        except Exception as e:
            self._logger.error(f"å¯¼èˆªé¢æ¿åˆ·æ–°å¤±è´¥: {e}")

    def set_item_enabled(self, item_name: str, enabled: bool) -> None:
        """
        è®¾ç½®å¯¼èˆªé¡¹çš„å¯ç”¨çŠ¶æ€

        Args:
            item_name: å¯¼èˆªé¡¹åç§°
            enabled: æ˜¯å¦å¯ç”¨
        """
        try:
            if item_name in self._tree_items:
                tree_item = self._tree_items[item_name]
                tree_item.setDisabled(not enabled)

        except Exception as e:
            self._logger.error(f"è®¾ç½®å¯¼èˆªé¡¹çŠ¶æ€å¤±è´¥: {e}")

    def add_badge(self, item_name: str, badge_text: str) -> None:
        """
        ä¸ºå¯¼èˆªé¡¹æ·»åŠ å¾½ç« 

        Args:
            item_name: å¯¼èˆªé¡¹åç§°
            badge_text: å¾½ç« æ–‡æœ¬
        """
        try:
            if item_name in self._tree_items and item_name in self._navigation_items:
                tree_item = self._tree_items[item_name]
                nav_item = self._navigation_items[item_name]

                # æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬ï¼Œæ·»åŠ å¾½ç« 
                display_text = f"{nav_item.display_name} ({badge_text})"
                tree_item.setText(0, display_text)

        except Exception as e:
            self._logger.error(f"æ·»åŠ å¾½ç« å¤±è´¥: {e}")

    def remove_badge(self, item_name: str) -> None:
        """
        ç§»é™¤å¯¼èˆªé¡¹çš„å¾½ç« 

        Args:
            item_name: å¯¼èˆªé¡¹åç§°
        """
        try:
            if item_name in self._tree_items and item_name in self._navigation_items:
                tree_item = self._tree_items[item_name]
                nav_item = self._navigation_items[item_name]

                # æ¢å¤åŸå§‹æ˜¾ç¤ºæ–‡æœ¬
                tree_item.setText(0, nav_item.display_name)

        except Exception as e:
            self._logger.error(f"ç§»é™¤å¾½ç« å¤±è´¥: {e}")
